---
title: "Stats"
author: "Julia Prein"
date: "12/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) # data handling etc.
library(viridis) # col scales, plotting...
library(ggpubr)
library(ggridges)
library(ggthemes)
library(tidyboot) # for bootstrap CIs
library(brms) # modeling
library(splithalfr) # reliability 

options(scipen = 999)
theme_set(theme_classic())
```

```{r load_data}
testtrials <- readRDS(file = "../data/gafo-testtrials.rds") %>% 
  # determine order of factors
  mutate(
    targetPosition = factor(targetPosition, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "box1", "box2", "box3", "box4", "box5")), 
    studyversion = factor(studyversion, levels = c("hedge", "box")), 
    datacollection = factor(datacollection, levels = c("in-person - supervised", "remote - unsupervised")),
    sample = factor(sample, levels = c("kids", "adults")), 
    studytype = factor(studytype, levels = c("vali", "vali2", "reli")),
    
    # for models, summarize targetPositions in a way that it's symmetrical for left/ right side
    # the smaller the value, the more central the position
    symmetricPosition = case_when(
                                  targetPosition == "5" | targetPosition == "6" | targetPosition == "box3" ~ 1, 
                                  targetPosition == "4" | targetPosition == "7" | targetPosition == "box2" | targetPosition == "box4" ~ 2,
                                  targetPosition == "3" | targetPosition == "8" | targetPosition == "box1" | targetPosition == "box5" ~ 3, 
                                  targetPosition == "2" | targetPosition == "9" ~ 4,
                                  targetPosition == "1" | targetPosition == "10" ~ 5, 
                       ), 
    
    # distance between target and click in balloon widths (balloon width is 160 SVG units)
    clickDistInBalloons = abs(clickDistFromTargetCenterX)/160,
  )
```

# VARIATION

```{r vali_data}
vali <- testtrials %>% 
  filter(studytype == "vali" & (ageInYears < 6 | ageInYears == 18)) %>% 
  mutate(ageInYears = factor(ageInYears, levels = c("3", "4", "5", "18")))
```

```{r variation_hedge_preparateData}
variationHedgeInd <- vali %>% 
  filter(studyversion == "hedge") %>% 
  mutate(
    ageInYearsExact = ifelse(sample == "kids", ageInMonths/12, 18), 
    ageInMonthsCentered = scale(ageInYearsExact, center = TRUE, scale = TRUE)[,1],
  ) %>% 
  group_by(sample, datacollection, ageInYears, ageInYearsExact, ageInMonthsCentered, subjID) %>%
  summarise(mean = mean(clickDistInBalloons, na.rm = TRUE))

variationHedge <- variationHedgeInd %>%
  group_by(sample, datacollection, ageInYears) %>%
  tidyboot_mean(column = mean)
```

```{r variation_hedge_plot}
hedge_variation_plot <- ggplot() +
  # child data
  geom_smooth(
    data = variationHedgeInd %>% filter(sample == "kids"),  
    aes(x = ageInYearsExact, y = mean, group = datacollection, lty = datacollection), 
    method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey",
  ) + 
  
  geom_point(
    data = variationHedgeInd %>% filter(sample == "kids"), 
    aes(x = ageInYearsExact, y = mean, col = ageInYears, shape = datacollection, alpha = datacollection)
  ) +
  
  geom_pointrange(
    data = variationHedge %>% filter(sample == "kids"), 
    aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = ageInYears, shape = datacollection, alpha = datacollection), size = 0.8, position=position_dodge(width = 0.1)
  ) +
  
  scale_shape_manual(values = c(16, 18)) + 
  scale_alpha_discrete(range = c(1, 0.4)) + 
  scale_linetype_manual(values = c("solid", "dashed")) + 
  
  # adult data
  geom_jitter(
    data = variationHedgeInd %>% filter(sample == "adults"), 
    aes(x = 6.5, y = mean, col = ageInYears, shape = datacollection), alpha = 0.5, width = .05, height = .01,  
  ) +

  geom_pointrange(
    data = variationHedge %>% filter(sample == "adults"), 
    aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper, shape = datacollection), 
    size = 0.8,
  ) +
  
  labs(x = "Age in years", y = "Average imprecision in target width", col = "Age group", shape = "Data collection mode", alpha = "Data collection mode", lty = "Data collection mode") + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d", "darkgrey"), breaks = c("3", "4", "5", "18"), labels = c("3-year-olds", "4-year-olds", "5-year-olds", "Adults")) +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 

  theme(legend.text = element_text(size = 8),
        legend.key.size = unit(0.4, "cm"), 
        legend.direction = "vertical", 
        legend.box = "horizontal",
        legend.position = c(0.72, 0.85), 
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")
        )

hedge_variation_plot

ggsave("../figures/gafo_hedge_variation.png", width = 7, height = 4)
```

```{r age_hedge_model}
mDataAgeHedge <- vali %>% 
  filter(studyversion == "hedge" & sample == "kids") %>% 
  mutate(
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, center = TRUE, scale = TRUE)[,1], 
  ) %>% 
  select(subjID, age, datacollection, symmetricPosition, targetPosition, clickDistInBalloons)

mAgeHedge <- brm(clickDistInBalloons ~ age + datacollection + (symmetricPosition | subjID) + (1 | targetPosition),
                    data = mDataAgeHedge,
                    family = lognormal(),
                    warmup = 1000, 
                    iter   = 3000, 
                    chains = 4, 
                    inits  = "random",
                    cores  = 4)

write.csv(mAgeHedge, "../saves/mAgeHedge.csv", quote = F, row.names = F)
saveRDS(mAgeHedge, "../saves/mAgeHedge.rds")
```

```{r variation_box_prepareData}
variationBoxInd <- vali %>% 
  filter(studyversion == "box") %>% 
  mutate(
    ageInYearsExact = ifelse(sample == "kids", ageInMonths/12, 18), 
    ageInMonthsCentered = scale(ageInYearsExact, center = TRUE, scale = TRUE)[,1],
  ) %>% 
  group_by(sample, datacollection, ageInYears, ageInYearsExact, ageInMonthsCentered, subjID) %>% 
  summarise(mean = mean(correctBox, na.rm = TRUE))

variationBox <- variationBoxInd %>%
  group_by(sample, datacollection, ageInYears) %>%
  tidyboot_mean(column = mean)
```

```{r variation_box_plot}
# with remote sample
box_variation_plot <- ggplot() +
  # chance level
  geom_segment(aes(x = 3.0, y = 0.2, xend = 6.2, yend = 0.2), lty = "dotted") + 
  geom_segment(aes(x = 6.25, y = 0.125, xend = 6.75, yend = 0.125), lty = "dotted") + 
  
  # child data
  geom_smooth(
    data = variationBoxInd %>% filter(sample == "kids"),  
    aes(x = ageInYearsExact, y = mean, group = datacollection, lty = datacollection), 
    method = "glm", size = 0.5, alpha = 0.15, col = "darkgrey",
  ) + 
  
  geom_point(
    data = variationBoxInd %>% filter(sample == "kids"), 
    aes(x = ageInYearsExact, y = mean, col = ageInYears, shape = datacollection, alpha = datacollection)
  ) +
  
  geom_pointrange(
    data = variationBox %>% filter(sample == "kids"), 
    aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = ageInYears, shape = datacollection, alpha = datacollection), size = 0.8, position=position_dodge(width = 0.1)
  ) +
  
  scale_shape_manual(values = c(16, 18)) + 
  scale_alpha_discrete(range = c(1, 0.4)) + 
  scale_linetype_manual(values = c("solid", "dashed")) + 
  
  # adult data
  geom_jitter(
    data = variationBoxInd %>% filter(sample == "adults"), 
    aes(x = 6.5, y = mean, col = ageInYears, shape = datacollection), alpha = 0.5, width = .05, height = .01,  
  ) +

  geom_pointrange(
    data = variationBox %>% filter(sample == "adults"), 
    aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper, shape = datacollection), 
    size = 0.8,
  ) +
  
  labs(x = "Age in years", y = "Proportion correct", col = "Age in years", shape = "Data collection mode", alpha = "Data collection mode", lty = "Data collection mode") + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d", "darkgrey"), breaks = c("3", "4", "5", "18"), labels = c("3-year-olds", "4-year-olds", "5-year-olds", "Adults")) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 
  theme(legend.position="none")

box_variation_plot

ggsave("../figures/gafo_box_variation.png", width = 5, height = 4)
```

```{r age_box_model}
# define data
mDataAgeBox <- vali %>% 
  filter(studyversion == "box" & sample == "kids") %>% 
  mutate(
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, center = TRUE, scale = TRUE)[,1], 
  ) %>% 
  select(subjID, age, datacollection, symmetricPosition, targetPosition, correctBox)

mAgeBox <- brm(correctBox ~ age + datacollection + (symmetricPosition | subjID) + (1 | targetPosition),
                    data = mDataAgeBox,
                    family = bernoulli(link = "logit"),
                    warmup = 1000, 
                    iter   = 3000, 
                    chains = 4, 
                    inits  = "random",
                    cores  = 4)

write.csv(mAgeBox, "../saves/mAgeBox.csv", quote = F, row.names = F)
saveRDS(mAgeBox, "../saves/mAgeBox.rds")
```

# RELI

```{r reli_data}
reli <- testtrials %>% 
  filter(studytype == "reli" & (ageInYears < 6 | ageInYears == 18) & completedReli == TRUE) %>% 
  mutate(ageInYears = factor(ageInYears, levels = c("3", "4", "5", "18")))

reli %>%
  group_by(subjID) %>%
  slice(1) %>%
  ungroup() %>% 
  select(ageInYears, studyversion) %>%
  ftable()
```

## Internal consistency
```{r intCon_hedge_data}
# take data of first reli day for internal consistency
hedge_intCon <- reli %>% 
  filter(studyversion == "hedge" & reliday == "reliday1") %>% 
  mutate(
    testhalf = ifelse(trialNr %% 2 == 0, "even_trials", "odd_trials")
  ) %>% 
  group_by(subjID, testhalf, sample, ageInYears) %>%
  tidyboot_mean(column = clickDistInBalloons, na.rm = TRUE)

hedge_intCon <- hedge_intCon %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, testhalf) %>%
  pivot_wider(
    names_from = testhalf,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
psych::describeBy(hedge_intCon, hedge_intCon$sample)
```

```{r intCon_hedge_kids}
hedge_intCon_kids <- hedge_intCon %>% 
  filter(sample == "kids") %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(aes(col = ageInYears), size = 0.7) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), guide = "none") +
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 5, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) +
  labs(x = "Even trials", y = "Odd trials")

hedge_intCon_kids

ggsave("../figures/gafo_hedge_intCon_kids.png", width = 6, height = 4)
```

```{r intCon_hedge_adults}
hedge_intCon_adults <- hedge_intCon %>% 
  filter(sample == "adults") %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(col = "darkgrey", size = 1.2, shape = 18, alpha = 0.5) + 
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 2, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 2), breaks = seq(0, 2, 0.5)) +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, 0.5)) +
  labs(x = "Even trials", y = "Odd trials")

hedge_intCon_adults

ggsave("../figures/gafo_hedge_intCon_adults.png", width = 6, height = 4)
```

```{r intCon_box_data}
# take data of first reli day for internal consistency
box_intCon <- reli %>% 
  filter(studyversion == "box" & reliday == "reliday1") %>% 
  mutate(
    testhalf = ifelse(trialNr %% 2 == 0, "even_trials", "odd_trials")
  ) %>% 
  group_by(subjID, testhalf, sample, ageInYears) %>%
  tidyboot_mean(column = correctBox, na.rm = TRUE)

box_intCon <- box_intCon %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, testhalf) %>%
  pivot_wider(
    names_from = testhalf,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
psych::describeBy(box_intCon, box_intCon$sample)
```

```{r intCon_box_kids}
box_intCon_kids <- box_intCon %>% 
  filter(sample == "kids") %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(aes(col = ageInYears), size = 0.7) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), guide = "none") +
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 1, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  labs(x = "Even trials", y = "Odd trials")

box_intCon_kids

ggsave("../figures/gafo_box_intCon_kids.png", width = 6, height = 4)
```

```{r intCon_box_adults}
box_intCon_adults <- box_intCon %>% 
  filter(sample == "adults") %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(col = "darkgrey", size = 1.2, shape = 18, alpha = 0.5) + 
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 1, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  labs(x = "Even trials", y = "Odd trials")

box_intCon_adults

ggsave("../figures/gafo_box_intCon_adults.png", width = 6, height = 4)
```

```{r splithalfr_hedge_kids}
fn_score_hedge <- function(ds) {
  return(mean(ds$clickDistInBalloons, na.rm = TRUE))
}

hedge_intCon_data <- reli %>% 
  filter(studyversion == "hedge" & reliday == "reliday1")

# first-second half split
splitscores_hedge_firstsecond_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("first_second"),
  ncores = 1,
  verbose = F
)

hedge_firstsecond_kids <- split_coefs(splitscores_hedge_firstsecond_kids, cor)
hedge_firstsecond_kids_ci <- split_ci(splitscores_hedge_firstsecond_kids, cor)

splithalf_data <- tibble(
                          sample = "kids", 
                          studyversion = "hedge", 
                          method = "first-second", 
                          stratification = "none",                                        
                          coefficient = hedge_firstsecond_kids, 
                          CI_lower = hedge_firstsecond_kids_ci$lims["0.025","bca"], 
                          CI_upper = hedge_firstsecond_kids_ci$lims["0.975","bca"]
                        )

# first-second half stratified by target position
splitscores_hedge_firstsecondStrat_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("first_second"),
  ncores = 1,
  verbose = F, 
  stratification = hedge_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

hedge_firstsecondStrat_kids <- split_coefs(splitscores_hedge_firstsecondStrat_kids, cor)
hedge_firstsecondStrat_kids_ci <- split_ci(splitscores_hedge_firstsecondStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "first-second",
                                        stratification = "target position",
                                        coefficient = hedge_firstsecondStrat_kids,
                                        CI_lower = hedge_firstsecondStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_firstsecondStrat_kids_ci$lims["0.975","bca"]
                                      )

# odd-even split
splitscores_hedge_oddeven_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("odd_even"),
  ncores = 1,
  verbose = F
)

hedge_oddeven_kids <- split_coefs(splitscores_hedge_oddeven_kids, cor)
hedge_oddeven_kids_ci <- split_ci(splitscores_hedge_oddeven_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "odd-even",
                                        stratification = "none",
                                        coefficient = hedge_oddeven_kids,
                                        CI_lower = hedge_oddeven_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_oddeven_kids_ci$lims["0.975","bca"]
                                      )

# odd-even split stratified by target position
splitscores_hedge_oddevenStrat_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("odd_even"),
  ncores = 1,
  verbose = F, 
  stratification = hedge_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

hedge_oddevenStrat_kids <- split_coefs(splitscores_hedge_oddevenStrat_kids, cor)
hedge_oddevenStrat_kids_ci <- split_ci(splitscores_hedge_oddevenStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "odd-even",
                                        stratification = "target position",
                                        coefficient = hedge_oddevenStrat_kids,
                                        CI_lower = hedge_oddevenStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_oddevenStrat_kids_ci$lims["0.975","bca"]
                                      )

# permutated splitting (random sampling without replacement)
splitscores_hedge_permutated_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
)

hedge_permutated_kids <- split_coefs(splitscores_hedge_permutated_kids, cor)
hedge_permutated_kids_ci <- split_ci(splitscores_hedge_permutated_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "permutated",
                                        stratification = "none",
                                        coefficient = hedge_permutated_kids,
                                        CI_lower = hedge_permutated_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_permutated_kids_ci$lims["0.975","bca"]
                                      )

# permutated splitting stratified by target position
splitscores_hedge_permutatedStrat_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  stratification = hedge_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

hedge_permutatedStrat_kids <- split_coefs(splitscores_hedge_permutatedStrat_kids, cor)
hedge_permutatedStrat_kids_ci <- split_ci(splitscores_hedge_permutatedStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "permutated",
                                        stratification = "target position",
                                        coefficient = hedge_permutatedStrat_kids,
                                        CI_lower = hedge_permutatedStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_permutatedStrat_kids_ci$lims["0.975","bca"]
                                      )

# monte carlo (sampling with replacement)
splitscores_hedge_montecarlo_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
)

hedge_montecarlo_kids <- split_coefs(splitscores_hedge_montecarlo_kids, cor)
hedge_montecarlo_kids_ci <- split_ci(splitscores_hedge_montecarlo_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "Monte Carlo",
                                        stratification = "none",
                                        coefficient = hedge_montecarlo_kids,
                                        CI_lower = hedge_montecarlo_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_montecarlo_kids_ci$lims["0.975","bca"]
                                      )

# monte carlo stratified by target position
splitscores_hedge_montecarloStrat_kids <- by_split(
  hedge_intCon_data %>% filter(sample == "kids"),
  hedge_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
  stratification = hedge_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

hedge_montecarloStrat_kids <- split_coefs(splitscores_hedge_montecarloStrat_kids, cor)
hedge_montecarloStrat_kids_ci <- split_ci(splitscores_hedge_montecarloStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "hedge", 
                                        method = "Monte Carlo",
                                        stratification = "target position",
                                        coefficient = hedge_montecarloStrat_kids,
                                        CI_lower = hedge_montecarloStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_montecarloStrat_kids_ci$lims["0.975","bca"]
                                      )
```

```{r splithalfr_hedge_adults}
# first-second half split
splitscores_hedge_firstsecond_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("first_second"),
  ncores = 1,
  verbose = F
)

hedge_firstsecond_adults <- split_coefs(splitscores_hedge_firstsecond_adults, cor)
hedge_firstsecond_adults_ci <- split_ci(splitscores_hedge_firstsecond_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                              sample = "adults", 
                                              studyversion = "hedge", 
                                              method = "first-second", 
                                              stratification = "none",                                        
                                              coefficient = hedge_firstsecond_adults, 
                                              CI_lower = hedge_firstsecond_adults_ci$lims["0.025","bca"], 
                                              CI_upper = hedge_firstsecond_adults_ci$lims["0.975","bca"]
                                            )

# first-second half stratified by target position
splitscores_hedge_firstsecondStrat_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("first_second"),
  ncores = 1,
  verbose = F, 
  stratification = hedge_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

hedge_firstsecondStrat_adults <- split_coefs(splitscores_hedge_firstsecondStrat_adults, cor)
hedge_firstsecondStrat_adults_ci <- split_ci(splitscores_hedge_firstsecondStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "first-second",
                                        stratification = "target position",
                                        coefficient = hedge_firstsecondStrat_adults,
                                        CI_lower = hedge_firstsecondStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_firstsecondStrat_adults_ci$lims["0.975","bca"]
                                      )

# odd-even split
splitscores_hedge_oddeven_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("odd_even"),
  ncores = 1,
  verbose = F
)

hedge_oddeven_adults <- split_coefs(splitscores_hedge_oddeven_adults, cor)
hedge_oddeven_adults_ci <- split_ci(splitscores_hedge_oddeven_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "odd-even",
                                        stratification = "none",
                                        coefficient = hedge_oddeven_adults,
                                        CI_lower = hedge_oddeven_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_oddeven_adults_ci$lims["0.975","bca"]
                                      )

# odd-even split stratified by target position
splitscores_hedge_oddevenStrat_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("odd_even"),
  ncores = 1,
  verbose = F, 
  stratification = hedge_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

hedge_oddevenStrat_adults <- split_coefs(splitscores_hedge_oddevenStrat_adults, cor)
hedge_oddevenStrat_adults_ci <- split_ci(splitscores_hedge_oddevenStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "odd-even",
                                        stratification = "target position",
                                        coefficient = hedge_oddevenStrat_adults,
                                        CI_lower = hedge_oddevenStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_oddevenStrat_adults_ci$lims["0.975","bca"]
                                      )

# permutated splitting (random sampling without replacement)
splitscores_hedge_permutated_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
)

hedge_permutated_adults <- split_coefs(splitscores_hedge_permutated_adults, cor)
hedge_permutated_adults_ci <- split_ci(splitscores_hedge_permutated_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "permutated",
                                        stratification = "none",
                                        coefficient = hedge_permutated_adults,
                                        CI_lower = hedge_permutated_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_permutated_adults_ci$lims["0.975","bca"]
                                      )

# permutated splitting stratified by target position
splitscores_hedge_permutatedStrat_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  stratification = hedge_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

hedge_permutatedStrat_adults <- split_coefs(splitscores_hedge_permutatedStrat_adults, cor)
hedge_permutatedStrat_adults_ci <- split_ci(splitscores_hedge_permutatedStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "permutated",
                                        stratification = "target position",
                                        coefficient = hedge_permutatedStrat_adults,
                                        CI_lower = hedge_permutatedStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_permutatedStrat_adults_ci$lims["0.975","bca"]
                                      )

# monte carlo (sampling with replacement)
splitscores_hedge_montecarlo_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
)

hedge_montecarlo_adults <- split_coefs(splitscores_hedge_montecarlo_adults, cor)
hedge_montecarlo_adults_ci <- split_ci(splitscores_hedge_montecarlo_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "Monte Carlo",
                                        stratification = "none",
                                        coefficient = hedge_montecarlo_adults,
                                        CI_lower = hedge_montecarlo_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_montecarlo_adults_ci$lims["0.975","bca"]
                                      )

# monte carlo stratified by target position
splitscores_hedge_montecarloStrat_adults <- by_split(
  hedge_intCon_data %>% filter(sample == "adults"),
  hedge_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_hedge,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
  stratification = hedge_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

hedge_montecarloStrat_adults <- split_coefs(splitscores_hedge_montecarloStrat_adults, cor)
hedge_montecarloStrat_adults_ci <- split_ci(splitscores_hedge_montecarloStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "hedge", 
                                        method = "Monte Carlo",
                                        stratification = "target position",
                                        coefficient = hedge_montecarloStrat_adults,
                                        CI_lower = hedge_montecarloStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = hedge_montecarloStrat_adults_ci$lims["0.975","bca"]
                                      )
```

```{r splithalfr_box_kids}
fn_score_box <- function(ds) {
  return(mean(ds$correctBox, na.rm = TRUE))
}

box_intCon_data <- reli %>% 
  filter(studyversion == "box" & reliday == "reliday1") 

# first-second half split
splitscores_box_firstsecond_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("first_second"),
  ncores = 1,
  verbose = F
)

box_firstsecond_kids <- split_coefs(splitscores_box_firstsecond_kids, cor)
box_firstsecond_kids_ci <- split_ci(splitscores_box_firstsecond_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                              sample = "kids", 
                                              studyversion = "box", 
                                              method = "first-second", 
                                              stratification = "none",                                        
                                              coefficient = box_firstsecond_kids, 
                                              CI_lower = box_firstsecond_kids_ci$lims["0.025","bca"], 
                                              CI_upper = box_firstsecond_kids_ci$lims["0.975","bca"]
                                            )

# first-second half stratified by target position
splitscores_box_firstsecondStrat_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("first_second"),
  ncores = 1,
  verbose = F, 
  stratification = box_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

box_firstsecondStrat_kids <- split_coefs(splitscores_box_firstsecondStrat_kids, cor)
box_firstsecondStrat_kids_ci <- split_ci(splitscores_box_firstsecondStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "first-second",
                                        stratification = "target position",
                                        coefficient = box_firstsecondStrat_kids,
                                        CI_lower = box_firstsecondStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_firstsecondStrat_kids_ci$lims["0.975","bca"]
                                      )

# odd-even split
splitscores_box_oddeven_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("odd_even"),
  ncores = 1,
  verbose = F
)

box_oddeven_kids <- split_coefs(splitscores_box_oddeven_kids, cor)
box_oddeven_kids_ci <- split_ci(splitscores_box_oddeven_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "odd-even",
                                        stratification = "none",
                                        coefficient = box_oddeven_kids,
                                        CI_lower = box_oddeven_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_oddeven_kids_ci$lims["0.975","bca"]
                                      )

# odd-even split stratified by target position
splitscores_box_oddevenStrat_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("odd_even"),
  ncores = 1,
  verbose = F, 
  stratification = box_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

box_oddevenStrat_kids <- split_coefs(splitscores_box_oddevenStrat_kids, cor)
box_oddevenStrat_kids_ci <- split_ci(splitscores_box_oddevenStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "odd-even",
                                        stratification = "target position",
                                        coefficient = box_oddevenStrat_kids,
                                        CI_lower = box_oddevenStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_oddevenStrat_kids_ci$lims["0.975","bca"]
                                      )

# permutated splitting (random sampling without replacement)
splitscores_box_permutated_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
)

box_permutated_kids <- split_coefs(splitscores_box_permutated_kids, cor)
box_permutated_kids_ci <- split_ci(splitscores_box_permutated_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "permutated",
                                        stratification = "none",
                                        coefficient = box_permutated_kids,
                                        CI_lower = box_permutated_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_permutated_kids_ci$lims["0.975","bca"]
                                      )

# permutated splitting stratified by target position
splitscores_box_permutatedStrat_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  stratification = box_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

box_permutatedStrat_kids <- split_coefs(splitscores_box_permutatedStrat_kids, cor)
box_permutatedStrat_kids_ci <- split_ci(splitscores_box_permutatedStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "permutated",
                                        stratification = "target position",
                                        coefficient = box_permutatedStrat_kids,
                                        CI_lower = box_permutatedStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_permutatedStrat_kids_ci$lims["0.975","bca"]
                                      )

# monte carlo (sampling with replacement)
splitscores_box_montecarlo_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
)

box_montecarlo_kids <- split_coefs(splitscores_box_montecarlo_kids, cor)
box_montecarlo_kids_ci <- split_ci(splitscores_box_montecarlo_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "Monte Carlo",
                                        stratification = "none",
                                        coefficient = box_montecarlo_kids,
                                        CI_lower = box_montecarlo_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_montecarlo_kids_ci$lims["0.975","bca"]
                                      )

# monte carlo stratified by target position
splitscores_box_montecarloStrat_kids <- by_split(
  box_intCon_data %>% filter(sample == "kids"),
  box_intCon_data %>% filter(sample == "kids") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
  stratification = box_intCon_data %>% filter(sample == "kids") %>% pull(symmetricPosition),
)

box_montecarloStrat_kids <- split_coefs(splitscores_box_montecarloStrat_kids, cor)
box_montecarloStrat_kids_ci <- split_ci(splitscores_box_montecarloStrat_kids, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "kids", 
                                        studyversion = "box", 
                                        method = "Monte Carlo",
                                        stratification = "target position",
                                        coefficient = box_montecarloStrat_kids,
                                        CI_lower = box_montecarloStrat_kids_ci$lims["0.025","bca"], 
                                        CI_upper = box_montecarloStrat_kids_ci$lims["0.975","bca"]
                                      )
```

```{r splithalfr_box_adults}
# first-second half split
splitscores_box_firstsecond_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("first_second"),
  ncores = 1,
  verbose = F
)

box_firstsecond_adults <- split_coefs(splitscores_box_firstsecond_adults, cor)
box_firstsecond_adults_ci <- split_ci(splitscores_box_firstsecond_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                              sample = "adults", 
                                              studyversion = "box", 
                                              method = "first-second", 
                                              stratification = "none",                                        
                                              coefficient = box_firstsecond_adults, 
                                              CI_lower = box_firstsecond_adults_ci$lims["0.025","bca"], 
                                              CI_upper = box_firstsecond_adults_ci$lims["0.975","bca"]
                                            )

# first-second half stratified by target position
splitscores_box_firstsecondStrat_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("first_second"),
  ncores = 1,
  verbose = F, 
  stratification = box_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

box_firstsecondStrat_adults <- split_coefs(splitscores_box_firstsecondStrat_adults, cor)
box_firstsecondStrat_adults_ci <- split_ci(splitscores_box_firstsecondStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "first-second",
                                        stratification = "target position",
                                        coefficient = box_firstsecondStrat_adults,
                                        CI_lower = box_firstsecondStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_firstsecondStrat_adults_ci$lims["0.975","bca"]
                                      )

# odd-even split
splitscores_box_oddeven_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("odd_even"),
  ncores = 1,
  verbose = F
)

box_oddeven_adults <- split_coefs(splitscores_box_oddeven_adults, cor)
box_oddeven_adults_ci <- split_ci(splitscores_box_oddeven_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "odd-even",
                                        stratification = "none",
                                        coefficient = box_oddeven_adults,
                                        CI_lower = box_oddeven_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_oddeven_adults_ci$lims["0.975","bca"]
                                      )

# odd-even split stratified by target position
splitscores_box_oddevenStrat_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("odd_even"),
  ncores = 1,
  verbose = F, 
  stratification = box_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

box_oddevenStrat_adults <- split_coefs(splitscores_box_oddevenStrat_adults, cor)
box_oddevenStrat_adults_ci <- split_ci(splitscores_box_oddevenStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "odd-even",
                                        stratification = "target position",
                                        coefficient = box_oddevenStrat_adults,
                                        CI_lower = box_oddevenStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_oddevenStrat_adults_ci$lims["0.975","bca"]
                                      )

# permutated splitting (random sampling without replacement)
splitscores_box_permutated_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
)

box_permutated_adults <- split_coefs(splitscores_box_permutated_adults, cor)
box_permutated_adults_ci <- split_ci(splitscores_box_permutated_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "permutated",
                                        stratification = "none",
                                        coefficient = box_permutated_adults,
                                        CI_lower = box_permutated_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_permutated_adults_ci$lims["0.975","bca"]
                                      )

# permutated splitting stratified by target position
splitscores_box_permutatedStrat_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  stratification = box_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

box_permutatedStrat_adults <- split_coefs(splitscores_box_permutatedStrat_adults, cor)
box_permutatedStrat_adults_ci <- split_ci(splitscores_box_permutatedStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "permutated",
                                        stratification = "target position",
                                        coefficient = box_permutatedStrat_adults,
                                        CI_lower = box_permutatedStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_permutatedStrat_adults_ci$lims["0.975","bca"]
                                      )

# monte carlo (sampling with replacement)
splitscores_box_montecarlo_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
)

box_montecarlo_adults <- split_coefs(splitscores_box_montecarlo_adults, cor)
box_montecarlo_adults_ci <- split_ci(splitscores_box_montecarlo_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "Monte Carlo",
                                        stratification = "none",
                                        coefficient = box_montecarlo_adults,
                                        CI_lower = box_montecarlo_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_montecarlo_adults_ci$lims["0.975","bca"]
                                      )

# monte carlo stratified by target position
splitscores_box_montecarloStrat_adults <- by_split(
  box_intCon_data %>% filter(sample == "adults"),
  box_intCon_data %>% filter(sample == "adults") %>% pull(subjID),
  fn_score_box,
  method = c("random"),
  ncores = 1,
  verbose = F, 
  replications = 1,
  replace = TRUE,
  stratification = box_intCon_data %>% filter(sample == "adults") %>% pull(symmetricPosition),
)

box_montecarloStrat_adults <- split_coefs(splitscores_box_montecarloStrat_adults, cor)
box_montecarloStrat_adults_ci <- split_ci(splitscores_box_montecarloStrat_adults, cor)

splithalf_data <- splithalf_data %>% add_row(
                                        sample = "adults", 
                                        studyversion = "box", 
                                        method = "Monte Carlo",
                                        stratification = "target position",
                                        coefficient = box_montecarloStrat_adults,
                                        CI_lower = box_montecarloStrat_adults_ci$lims["0.025","bca"], 
                                        CI_upper = box_montecarloStrat_adults_ci$lims["0.975","bca"]
                                      )
```

```{r splithalf_plot}
splithalf_data %>% 
  mutate(
    sample = fct_rev(sample), 
  ) %>%
  unite("samplegroup", c(studyversion, sample), sep = " - ", remove = FALSE) %>% 
  mutate(samplegroup = fct_rev(samplegroup)) %>%
  unite("methodStrat", c(method, stratification), sep = " - ", remove = FALSE) %>% 
  mutate(
    methodStrat = factor(methodStrat, levels = c("first-second - none", "first-second - target position", "odd-even - none", "odd-even - target position", "permutated - none", "permutated - target position", "Monte Carlo - none", "Monte Carlo - target position")) %>% fct_rev(), 
  ) %>%  
  ggplot(aes(x = methodStrat, y = coefficient, color = sample, group = studyversion)) + 
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), colour = "black", width = .1, position = position_dodge(0.1)) +
    geom_point(position = position_dodge(0.1), size = 3) +
    scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
    scale_color_manual(values = c("#006c66", "darkgrey"), guide = "none") +
    labs(x = "Splitting & stratification method", y = "") +
    coord_flip() + 
    facet_wrap(~ samplegroup, nrow = 1) + 
    theme(legend.position = "none", panel.spacing = unit(1.5, "lines"))

ggsave("../figures/gafo_splithalf.png", width = 8, height = 2.5, scale = 1.2)
```

```{r splithalf_table}
knitr::kable(splithalf_data)
```

```{r save_splithalf_data}
write.csv(splithalf_data, "../saves/gafo-splithalf.csv", quote = F, row.names = F)
saveRDS(splithalf_data, file = "../saves/gafo-splithalf.rds")
```

## Test-retest reliability 

```{r retest_hedge_data}
# take data of first reli day for internal consistency
hedge_retest <- reli %>% 
  filter(studyversion == "hedge") %>% 
  group_by(subjID, reliday, sample, ageInYears) %>% 
  tidyboot_mean(column = clickDistInBalloons, na.rm = TRUE)

hedge_retest <- hedge_retest %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, reliday) %>%
  pivot_wider(
    names_from = reliday,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
psych::describeBy(hedge_retest, hedge_retest$sample)

# calculate at which values we would start seing data as outliers
hedge_retest %>% 
  summarize(
    lower_reliday1 = mean(mean_reliday1) - 3*sd(mean_reliday1), 
    upper_reliday1 = mean(mean_reliday1) + 3*sd(mean_reliday1),
    lower_reliday2 = mean(mean_reliday2) - 3*sd(mean_reliday2),
    upper_reliday2 = mean(mean_reliday2) + 3*sd(mean_reliday2),
  )

# check how many there are
hedge_retest %>% 
  filter(mean_reliday1 >= mean(mean_reliday1) + 3*sd(mean_reliday1) | 
         mean_reliday1 <= mean(mean_reliday1) - 3*sd(mean_reliday1) |
         mean_reliday2 >= mean(mean_reliday2) + 3*sd(mean_reliday2) |
         mean_reliday2 <= mean(mean_reliday2) - 3*sd(mean_reliday2))

# exclude 1 outlier
hedge_retest <- hedge_retest %>%
  filter(mean_reliday1 < mean(mean_reliday1) + 3*sd(mean_reliday1), mean_reliday1 > mean(mean_reliday1) - 3*sd(mean_reliday1),
         mean_reliday2 < mean(mean_reliday2) + 3*sd(mean_reliday2), mean_reliday2 > mean(mean_reliday2) - 3*sd(mean_reliday2))
```

```{r retest_hedge_kids}
hedge_retest_kids <- hedge_retest %>% 
  filter(sample == "kids") %>% 
  ggplot(., aes(x = mean_reliday1, y = mean_reliday2)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(aes(col = ageInYears), size = 0.7) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), guide = "none") +
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 4, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 4.1), breaks = seq(0, 4, 1)) +
  scale_y_continuous(limits = c(0, 4.1), breaks = seq(0, 4, 1)) +
  labs(x = "Testday 1", y = "Testday 2")

hedge_retest_kids

ggsave("../figures/gafo_hedge_retest_kids.png", width = 6, height = 4)
```

```{r retest_hedge_adults}
hedge_retest_adults <- hedge_retest %>% 
  filter(sample == "adults") %>% 
  ggplot(., aes(x = mean_reliday1, y = mean_reliday2)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(col = "darkgrey", size = 1.2, shape = 18, alpha = 0.5) + 
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 2, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 2), breaks = seq(0, 2, 0.5)) +
  scale_y_continuous(limits = c(0, 2), breaks = seq(0, 2, 0.5)) +
  labs(x = "Testday 1", y = "Testday 2")

hedge_retest_adults

ggsave("../figures/gafo_hedge_retest_adults.png", width = 6, height = 4)
```

```{r retest_hedge_model}
# define data
mDataRetestHedge <- reli %>% 
  filter(studyversion == "hedge" & sample == "kids") %>% 
  mutate(
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, center = TRUE, scale = TRUE)[,1], 
  ) %>% 
  select(subjID, age, reliday, clickDistInBalloons)

# run model
mRetestHedge <- brm(clickDistInBalloons ~ age + (0 + reliday | subjID), 
                              data   = mDataRetestHedge, 
                              family = lognormal(), 
                              warmup = 1000, 
                              iter   = 3000, 
                              chains = 4, 
                              inits  = "random",
                              cores  = 4)

write.csv(mRetestHedge, "../saves/mRetestHedge.csv", quote = F, row.names = F)
saveRDS(mRetestHedge, "../saves/mRetestHedge.rds")
```

```{r retest_box_data}
# take data of first reli day for internal consistency
box_retest <- reli %>% 
  filter(studyversion == "box") %>% 
  group_by(subjID, reliday, sample, ageInYears) %>% 
  tidyboot_mean(column = correctBox, na.rm = TRUE)

box_retest <- box_retest %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, reliday) %>%
  pivot_wider(
    names_from = reliday,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
psych::describeBy(box_retest, box_retest$sample)
```

```{r retest_box_kids}
box_retest_kids <- box_retest %>% 
  filter(sample == "kids") %>% 
  ggplot(., aes(x = mean_reliday1, y = mean_reliday2)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(aes(col = ageInYears), size = 0.7) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), guide = "none") +
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 1, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  labs(x = "Testday 1", y = "Testday 2")

box_retest_kids

ggsave("../figures/gafo_hedge_retest_kids.png", width = 6, height = 4)
```

```{r retest_box_adults}
box_retest_adults <- box_retest %>% 
  filter(sample == "adults") %>% 
  ggplot(., aes(x = mean_reliday1, y = mean_reliday2)) + 
  geom_abline(intercept = 0, slope = 1, col = "darkgrey", linetype = "longdash") +
  geom_point(col = "darkgrey", size = 1.2, shape = 18, alpha = 0.5) + 
  geom_smooth(method = "lm", size = 0.5, alpha = 0.15, col = "darkgrey") +
  stat_cor(method = "pearson", label.x = 0, label.y = 1, aes(label = paste(..r.label..)), size = 3.5, r.accuracy = 0.01, cor.coef.name = "r") + 
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  labs(x = "Testday 1", y = "Testday 2")

box_retest_adults

ggsave("../figures/gafo_hedge_retest_adults.png", width = 6, height = 4)
```

```{r retest_box_model}
# define data
mDataRetestBox <- reli %>% 
  filter(studyversion == "box" & sample == "kids") %>% 
  mutate(
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, center = TRUE, scale = TRUE)[,1], 
  ) %>% 
  select(subjID, age, reliday, correctBox)

# run model
mRetestBox <- brm(correctBox ~ age + (0 + reliday | subjID), 
                              data   = mDataRetestBox, 
                              family = bernoulli(link = "logit"),
                              warmup = 1000, 
                              iter   = 3000, 
                              chains = 4, 
                              inits  = "random",
                              cores  = 4)

write.csv(mRetestBox, "../saves/mRetestBox.csv", quote = F, row.names = F)
saveRDS(mRetestBox, "../saves/mRetestBox.rds")
```

# Save plots

```{r arrange_plots}
ggarrange(

  ggarrange(hedge_variation_plot,
            NULL,
            ggarrange(
              hedge_intCon_kids, 
              hedge_intCon_adults,
              hedge_retest_kids, 
              hedge_retest_adults, 
              nrow = 2, 
              ncol = 2, 
              labels = c("B", "C", "D", "E")
            ), 
            
            # hedge: space between vari and reli
            nrow = 1, widths = c(1, 0.06, 1),
            labels = c("A", "", "")
  ), 
  
  NULL, 
  
  ggarrange(box_variation_plot,
            NULL,
            ggarrange(
              box_intCon_kids,
              box_intCon_adults,
              box_retest_kids,
              box_retest_adults,
              nrow = 2, 
              ncol = 2,
              labels = c("G", "H", "I", "J")
            ), 
  
            # box: space between vari and reli
            nrow = 1, widths = c(1, 0.06, 1),
            labels = c("F", "", "")
  ), 
  
  # space between hedge & box
  nrow = 3, heights = c(1.2, 0.1, 1.2)
)

ggsave("../figures/gafo_results.png", width = 6.5, height = 5, scale = 1.6, bg = "white")
```

# EXTERNAL VALIDITY

```{r extvali_prepareData}
mDataExtvali <- testtrials %>% 
  filter(ageInYears < 6) %>% 
  select(datacollection, studyversion, subjID, gender, trialNr, ageInMonths, ageInYears, correctBox, childcareAge, childcareHours, householdTotal, siblingsNr, siblingsChildAged, siblingsVarietyScoreP, siblingsVarietyScoreW, targetPosition, symmetricPosition) %>% 
  group_by(subjID) %>% 
  # so that all models run with same nr of subjects
  drop_na() %>% 
  ungroup() %>% 
  mutate(
    # centered around minimum
    hhSibs = siblingsNr, 
    sibsChildAged = siblingsChildAged, 
    
    # centered around mean
    trial = scale(trialNr, center = TRUE, scale = FALSE)[,1],
    ccAge = scale(childcareAge, center = TRUE, scale = FALSE)[,1],
    ccHours = scale(childcareHours, center = TRUE, scale = FALSE)[,1],
    hhTotal = scale(householdTotal, center = TRUE, scale = FALSE)[,1],
    
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, center = TRUE, scale = TRUE)[,1], 
    peerExposure = scale(childcareHours, center = TRUE, scale = TRUE) + scale(siblingsNr, center = TRUE, scale = TRUE)[,1],
    pe = scale(peerExposure, center = TRUE, scale = TRUE)[,1], 
  ) %>% 
  select(datacollection, studyversion, subjID, trial, age, targetPosition, symmetricPosition, correctBox, ccAge, ccHours, hhTotal, hhSibs, sibsChildAged, siblingsVarietyScoreP, siblingsVarietyScoreW, pe) %>% 
  mutate_if(is.character, as.factor)

n_distinct(extvali$subjID)
```

```{r extvali_nullmodel}
mExtvalinull <- brm(correctBox ~ age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                    data = mDataExtvali,
                    family = bernoulli(link = "logit"),
                    warmup = 1000, 
                    iter   = 3000, 
                    chains = 4, 
                    inits  = "random",
                    cores  = 4)
```

```{r extvali_fullmodels}
mExtvaliccAge <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ ccAge + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvaliccHours <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ ccHours + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvalihhTotal <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ hhTotal + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvalihhSibs <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ hhSibs + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvalisibsChildAged <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ sibsChildAged + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvalisiblingsVarietyScoreP <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ siblingsVarietyScoreP + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvalisiblingsVarietyScoreW <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ siblingsVarietyScoreW + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)

mExtvaliPE <- update(mExtvalinull,
                      newdata = mDataExtvali,
                      formula = correctBox ~ pe + age + datacollection + studyversion + (symmetricPosition | subjID) + (1 | targetPosition),
                      family = bernoulli(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4)
```

```{r extvali_modelcomparisons}
mExtvalinull <- add_criterion(mExtvalinull, "waic")
mExtvaliccAge <- add_criterion(mExtvaliccAge, "waic")
mExtvaliccHours <- add_criterion(mExtvaliccHours, "waic")
mExtvalihhTotal <- add_criterion(mExtvalihhTotal, "waic")
mExtvalihhSibs <- add_criterion(mExtvalihhSibs, "waic")
mExtvalisibsChildAged <- add_criterion(mExtvalisibsChildAged, "waic")
mExtvalisiblingsVarietyScoreP <- add_criterion(mExtvalisiblingsVarietyScoreP, "waic")
mExtvalisiblingsVarietyScoreW <- add_criterion(mExtvalisiblingsVarietyScoreW, "waic")
mExtvaliPE <- add_criterion(mExtvaliPE, "waic")

mExtvaliComparison <- as_tibble(loo_compare(mExtvalinull, mExtvaliccAge, mExtvaliccHours, mExtvalihhTotal, mExtvalihhSibs, mExtvalisibsChildAged, mExtvalisiblingsVarietyScoreP, mExtvalisiblingsVarietyScoreW, mExtvaliPE, criterion = "waic"), rownames = "model")

mExtvaliComparison

mExtvaliComparisonWeights <- as_tibble(model_weights(mExtvalinull, mExtvaliccAge, mExtvaliccHours, mExtvalihhTotal, mExtvalihhSibs, mExtvalisibsChildAged, mExtvalisiblingsVarietyScoreP, mExtvalisiblingsVarietyScoreW, mExtvaliPE, criterion = "waic"), rownames = "model")

mExtvaliComparisonWeights %>% arrange(-value)

extvaliModelorder <- mExtvaliComparisonWeights %>% arrange(value) %>%  pull(model)
```

```{r extvali_plot}
extvaliPostSamples <- bind_rows(
  posterior_samples(mExtvaliccAge, pars = "b_ccAge") %>% mutate(model = "mExtvaliccAge") %>% rename(estimate = b_ccAge), 
  posterior_samples(mExtvaliccHours, pars = "b_ccHours") %>% mutate(model = "mExtvaliccHours") %>% rename(estimate = b_ccHours), 
  posterior_samples(mExtvalihhTotal, pars = "b_hhTotal") %>% mutate(model = "mExtvalihhTotal") %>% rename(estimate = b_hhTotal), 
  posterior_samples(mExtvalihhSibs, pars = "b_hhSibs") %>% mutate(model = "mExtvalihhSibs") %>% rename(estimate = b_hhSibs),
  posterior_samples(mExtvalisibsChildAged, pars = "b_sibsChildAged") %>% mutate(model = "mExtvalisibsChildAged") %>% rename(estimate = b_sibsChildAged),
  posterior_samples(mExtvalisiblingsVarietyScoreP, pars = "b_siblingsVarietyScoreP") %>% mutate(model = "mExtvalisiblingsVarietyScoreP") %>% rename(estimate = b_siblingsVarietyScoreP),
  posterior_samples(mExtvalisiblingsVarietyScoreW, pars = "b_siblingsVarietyScoreW") %>% mutate(model = "mExtvalisiblingsVarietyScoreW") %>% rename(estimate = b_siblingsVarietyScoreW),
  posterior_samples(mExtvaliPE, pars = "b_pe") %>% mutate(model = "mExtvaliPE") %>% rename(estimate = b_pe)
) %>% 
  mutate(
    model = factor(model, levels = extvaliModelorder) %>% str_remove(., "mExtvali"), 
  )

write.csv(extvali_results, "../saves/extvali-posteriorsamples.csv", quote = F, row.names = F)
saveRDS(extvali_results, "../saves/extvali-posteriorsamples.rds")

ggplot(extvaliPostSamples, aes(x = estimate, y = model, fill = factor(stat(quantile)))) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75) +
  stat_density_ridges(
    geom = "density_ridges_gradient",
    calc_ecdf = TRUE, 
    quantiles = c(0.025, 0.975)
  ) +	
  scale_fill_manual(values = c("#006c66", "NA", "#006c66"), guide = "none")

ggsave("../figures/extvali-posteriorsample.png")
```

```{r extvali_save}
extvali_results <- mExtvaliComparison %>%
  left_join(mExtvaliComparisonWeights) %>%
  select(model, waic, value, elpd_diff, se_diff) %>%
  rename(waic_weight = value) %>% 
  mutate(
    model = str_remove(model, "mExtvali")
  )

write.csv(extvali_results, "../saves/extvali-results.csv", quote = F, row.names = F)
saveRDS(extvali_results, "../saves/extvali-results.rds")
```

