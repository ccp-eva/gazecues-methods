---
title: "Stats"
author: "Julia Prein"
date: "12/17/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) # data handling etc.
library(viridis) # color scales, plotting...
library(ggpubr)
library(ggthemes)
library(tidyboot) # for bootstrap CIs
library(brms) # modeling
library(splithalfr) # reliability 

options(scipen = 999)
theme_set(theme_classic())
```

```{r load_data}
testtrials <- readRDS(file = "../data/gafo-testtrials.rds") %>% 
  # determine order of factors
  mutate(
    targetPosition = factor(targetPosition, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "box1", "box2", "box3", "box4", "box5")), 
    studyversion = factor(studyversion, levels = c("hedge", "box")), 
    datacollection = factor(datacollection, levels = c("in-person - supervised", "remote - unsupervised")),
    sample = factor(sample, levels = c("kids", "adults")), 
    studytype = factor(studytype, levels = c("vali", "vali2", "reli"))
  )
```

```{r vali_data}
vali <- testtrials %>% 
  filter(studytype == "vali" & (ageInYears < 6 | ageInYears == 18))
```

```{r variation_hedge_preparateData}
variationHedgeInd <- vali %>% 
  filter(studyversion == "hedge") %>% 
  mutate(
    ageInYearsExact = ifelse(sample == "kids", ageInMonths/12, 18), 
    ageInMonthsCentered = scale(ageInYearsExact, center = TRUE, scale = TRUE)[,1],
  ) %>% 
  group_by(sample, datacollection, ageInYears, ageInYearsExact, ageInMonthsCentered, subjID) %>%
  summarise(mean = mean(abs(clickDistFromTargetCenterX)/160, na.rm = TRUE))

variationHedge <- variationHedgeInd %>%
  group_by(sample, datacollection, ageInYears) %>%
  tidyboot_mean(column = mean)
```

```{r variation_hedge}
## variation without remote kids
ggplot() +
  # child data
  geom_smooth(data = variationHedgeInd %>% filter(sample == "kids" & datacollection == "in-person - supervised"),  aes(x = ageInYearsExact, y = mean), method = "glm", color = "darkgrey", alpha = 0.2) +
  geom_point(data = variationHedgeInd %>% filter(sample == "kids" & datacollection == "in-person - supervised"), aes(x = ageInYearsExact, y = mean, col = as.factor(ageInYears)), alpha = .5) +
  geom_pointrange(data = variationHedge %>% filter(sample == "kids" & datacollection == "in-person - supervised"), aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = as.factor(ageInYears)), size = 0.8, pch = 18) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), labels = c("3-year-olds", "4-year-olds", "5-year-olds")) +
  
  # adult data
  geom_jitter(data = variationHedgeInd %>% filter(sample == "adults"), aes(x = 6.5, y = mean), alpha = .15, width = .05, height = .01) +
  geom_pointrange(data = variationHedge %>% filter(sample == "adults"), aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper), size = 0.8, pch = 18) +  
  labs(x = "Age in years", y = "Average imprecision in target width", color = "Age group") + 
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 
  theme(legend.position = c(0.11, 0.18))

ggsave("../figures/gafo_hedge_variation.png", width = 6, height = 4)
```

```{r variation_hedge_remote}
# with remote sample
ggplot() +
  # child data
  geom_smooth(data = variationHedgeInd %>% filter(sample == "kids"),  aes(x = ageInYearsExact, y = mean, group = datacollection, col = datacollection), method = "glm", alpha = 0.2, size = 0.5) + 
  geom_point(data = variationHedgeInd %>% filter(sample == "kids"), aes(x = ageInYearsExact, y = mean, col = datacollection), alpha = .25) +
  geom_pointrange(data = variationHedge %>% filter(sample == "kids"), aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = datacollection), size = 0.8, pch = 18, position=position_dodge(width = 0.1)) +
  scale_color_manual(values = c("#00b1ea", "#29485d"), labels = c("in-person - supervised", "remote - unsupervised")) +
  
  # adult data
  # geom_jitter(data = variationHedgeInd %>% filter(sample == "adults"), aes(x = 6.5, y = mean), alpha = .15, width = .05, height = .01) +
  # geom_pointrange(data = variationHedge %>% filter(sample == "adults"), aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper), size = 0.8, pch = 18) +
  
  labs(x = "Age in years", y = "Average imprecision in target width", color = "Data collection mode") + 
  scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 1)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 
  theme(legend.position = c(0.85, 0.88))

ggsave("../figures/gafo_hedge_remote.png", width = 6, height = 4)
```

```{r variation_box_prepareData}
variationBoxInd <- vali %>% 
  filter(studyversion == "box") %>% 
  mutate(
    ageInYearsExact = ifelse(sample == "kids", ageInMonths/12, 18), 
    ageInMonthsCentered = scale(ageInYearsExact, center = TRUE, scale = TRUE)[,1],
  ) %>% 
  group_by(sample, datacollection, ageInYears, ageInYearsExact, ageInMonthsCentered, subjID) %>% 
  summarise(mean = mean(correctBox, na.rm = TRUE))

variationBox <- variationBoxInd %>%
  group_by(sample, datacollection, ageInYears) %>%
  tidyboot_mean(column = mean)
```

```{r variation_box} 
ggplot() +
  # chance level
  geom_hline(aes(yintercept = 0.2), lty = 1) + 
  geom_hline(aes(yintercept = 0.125), lty = 2) + 
  
  # child data
  geom_smooth(data = variationBoxInd %>% filter(sample == "kids" & datacollection == "in-person - supervised"),  aes(x = ageInYearsExact, y = mean), method = "glm", color = "darkgrey", alpha = 0.2) +
  geom_point(data = variationBoxInd %>% filter(sample == "kids" & datacollection == "in-person - supervised"), aes(x = ageInYearsExact, y = mean, col = as.factor(ageInYears)), alpha = .5) +
  geom_pointrange(data = variationBox %>% filter(sample == "kids" & datacollection == "in-person - supervised"), aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = as.factor(ageInYears)), size = 0.8, pch = 18) + 
  scale_color_manual(values = c("#00b1ea", "#006c66", "#29485d"), labels = c("3-year-olds", "4-year-olds", "5-year-olds")) +
  
  # adult data
  geom_jitter(data = variationBoxInd %>% filter(sample == "adults"), aes(x = 6.5, y = mean), alpha = .15, width = .05, height = .01) +
  geom_pointrange(data = variationBox %>% filter(sample == "adults"), aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper), size = 0.8, pch = 18) +  
  labs(x = "Age in years", y = "Proportion correct", color = "Age group") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 
  theme(legend.position = c(0.11, 0.85))

ggsave("../figures/gafo_box_variation.png", width = 6, height = 4)
```

```{r variation_box_remote}
# with remote sample
ggplot() +
  # chance level
  geom_hline(aes(yintercept = 0.2), lty = 1) + 
  # geom_hline(aes(yintercept = 0.125), lty = 2) + 
  
  # child data
  geom_smooth(data = variationBoxInd %>% filter(sample == "kids"),  aes(x = ageInYearsExact, y = mean, group = datacollection, col = datacollection), method = "glm", alpha = 0.2, size = 0.5) +
  geom_point(data = variationBoxInd %>% filter(sample == "kids"), aes(x = ageInYearsExact, y = mean, col = datacollection), alpha = .25) +
  geom_pointrange(data = variationBox %>% filter(sample == "kids"), aes(x = as.numeric(as.character(ageInYears))+.5, y = mean, ymin = ci_lower, ymax = ci_upper, col = datacollection), size = 0.8, pch = 18, position=position_dodge(width = 0.1)) +
  scale_color_manual(values = c("#00b1ea", "#29485d"), labels = c("in-person - supervised", "remote - unsupervised")) +
  
  # adult data
  # geom_jitter(data = variationBoxInd %>% filter(sample == "adults"), aes(x = 6.5, y = mean), alpha = .15, width = .05, height = .01) +
  # geom_pointrange(data = variationBox %>% filter(sample == "adults"), aes(x = 6.5, y = mean, ymin = ci_lower, ymax = ci_upper), size = 0.8, pch = 18) +
  
  labs(x = "Age in years", y = "Average imprecision in target width", color = "Data collection mode") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(3, 6.5, 0.5), labels = c("3.0", "3.5", "4.0", "4.5", "5.0", "5.5", "6.0", "Adults")) + 
  theme(legend.position = c(0.17, 0.9))

ggsave("../figures/gafo_box_remote.png", width = 6, height = 4)
```

```{r variation_hedge_intCon}
# check for kids that did not have at least 2 trials in each target position
# not happening for hedge version! since 10 bins but only 15 test trials 

hedge_intCon_data <- vali %>% 
  filter(studyversion == "hedge" & sample == "kids" & datacollection == "in-person - supervised") 
  # mutate(trialsPerPos = n()) %>% 
  # filter(trialsPerPos >= 2)

hedge_intCon <- hedge_intCon_data %>% 
  group_by(subjID, targetPosition) %>% 
  mutate(
    testhalf = ifelse(trialNr %% 2 == 0, "even_trials", "odd_trials")
  ) %>% 
  group_by(subjID, testhalf) %>%
  tidyboot_mean(col = abs(clickDistFromTargetCenterX)/160, na.rm = TRUE)

hedge_intCon <- hedge_intCon %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, testhalf) %>%
  pivot_wider(
    names_from = testhalf,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
hedge_intCon %>% psych::describe()

hedge_intCon %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_point(alpha = .5) + 
  geom_errorbarh(aes(xmin = ci_lower_even_trials, xmax = ci_upper_odd_trials), alpha = 0.3, col = "darkgrey") + 
  geom_errorbar(aes(ymin = ci_lower_even_trials, ymax = ci_upper_odd_trials), alpha = 0.3, col = "darkgrey") +
  # stat_cor(r.accuracy = 0.01, p.accuracy = 0.01) +
  geom_smooth(method = "lm", color = "#006c66", alpha = 0.25) +
  geom_abline(intercept = 0, slope = 1, color = "darkgrey", linetype = "longdash") +
  scale_x_continuous(breaks = seq(0, 7, 1)) +
  scale_y_continuous(breaks = seq(0, 7, 1)) +
  labs(x = "Average imprecision in target width in even trials", y = "Average imprecision in target width in odd trials")

ggsave("../figures/gafo_hedge_intCon.png", width = 6, height = 4)
```

```{r hedge_splithalfr}
fn_score_hedge <- function(ds) {
  return(mean(abs(ds$clickDistFromTargetCenterX)/160, na.rm = TRUE))
}

### ODD EVEN
split_scores_hedge_odd_even <- by_split(
  hedge_intCon_data,
  hedge_intCon_data$subjID,
  fn_score_hedge,
  replications = 1,
  method = c("odd_even"),
)

hedge_odd_even <- split_coefs(split_scores_hedge_odd_even, cor)
hedge_odd_even_ci  <- split_ci(split_scores_hedge_odd_even, cor)

save_splithalf <- tibble(hedge_odd_even)

### FIRST SECOND
split_scores_hedge_first_second <- by_split(
  hedge_intCon_data,
  hedge_intCon_data$subjID,
  fn_score_hedge,
  replications = 1,
  method = c("first_second"),
)

hedge_first_second <- split_coefs(split_scores_hedge_first_second, cor)
hedge_first_second_ci <- split_ci(split_scores_hedge_first_second, cor)

save_splithalf <- save_splithalf %>% 
  mutate(
    # add confidence interval of coefficients (bca: bias-corrected and accelerated bootstrap confidence intervals)
    hedge_odd_even_ci_lower = hedge_odd_even_ci$lims["0.025","bca"],
    hedge_odd_even_ci_upper = hedge_odd_even_ci$lims["0.975","bca"],
    
    # same for splitting according to first / second test half
    hedge_first_second = hedge_first_second, 
    hedge_first_second_ci_lower = hedge_first_second_ci$lims["0.025","bca"],
    hedge_first_second_ci_upper = hedge_first_second_ci$lims["0.975","bca"],
  )
```

```{r variation_box_intCon}
box_intCon_excluded <- vali %>% 
  filter(studyversion == "box" & sample == "kids" & datacollection == "in-person - supervised") %>% 
  group_by(subjID, targetPosition) %>% 
  summarise(trialsPerPos = n()) %>% 
  filter(trialsPerPos < 2)

box_intCon_excluded %>% 
  select(subjID) %>% 
  summarise(n = n_distinct(subjID))

box_intCon_data <- vali %>% 
  filter(studyversion == "box" & sample == "kids" & datacollection == "in-person - supervised" & subjID != "gk1-103") 

box_intCon <- box_intCon_data %>% 
  mutate(
    testhalf = ifelse(trialNr %% 2 == 0, "even_trials", "odd_trials")
  ) %>% 
  group_by(subjID, testhalf) %>%
  tidyboot_mean(col = correctBox, na.rm = TRUE)

box_intCon <- box_intCon %>% 
  select(-c(n, empirical_stat)) %>% 
  group_by(subjID, testhalf) %>%
  pivot_wider(
    names_from = testhalf,
    values_from = c(mean, ci_lower, ci_upper)
  ) %>%
  ungroup()

# summary
box_intCon %>% psych::describe()

box_intCon %>% 
  ggplot(., aes(x = mean_even_trials, y = mean_odd_trials)) + 
  geom_point(alpha = .5) + 
  geom_errorbarh(aes(xmin = ci_lower_even_trials, xmax = ci_upper_odd_trials), alpha = 0.3, col = "darkgrey") + 
  geom_errorbar(aes(ymin = ci_lower_even_trials, ymax = ci_upper_odd_trials), alpha = 0.3, col = "darkgrey") +
  # stat_cor(r.accuracy = 0.01, p.accuracy = 0.01) +
  geom_smooth(method = "lm", color = "#006c66", alpha = 0.25) +
  geom_abline(intercept = 0, slope = 1, color = "darkgrey", linetype = "longdash") +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  labs(x = "Average imprecision in target width in even trials", y = "Average imprecision in target width in odd trials")

ggsave("../figures/gafo_box_intCon.png", width = 6, height = 4)
```


```{r box_splithalfr}
fn_score_box <- function(ds) {
  return(mean(ds$correctBox, na.rm = TRUE))
}

### ODD EVEN
split_scores_box_odd_even <- by_split(
  box_intCon_data,
  box_intCon_data$subjID,
  fn_score_box,
  replications = 1,
  method = c("odd_even"),
)

box_odd_even = split_coefs(split_scores_box_odd_even, cor)
box_odd_even_ci = split_ci(split_scores_box_odd_even, cor)
  
### FIRST SECOND
split_scores_box_first_second <- by_split(
  box_intCon_data,
  box_intCon_data$subjID,
  fn_score_box,
  replications = 1,
  method = c("first_second"),
)

box_first_second = split_coefs(split_scores_box_first_second, cor)
box_first_second_ci = split_ci(split_scores_box_first_second, cor)

save_splithalf <- save_splithalf %>% 
  mutate(
    # add splitting according to odd / even test half
    box_odd_even = box_odd_even, 
    box_odd_even_ci_lower = box_odd_even_ci$lims["0.025","bca"],
    box_odd_even_ci_upper = box_odd_even_ci$lims["0.975","bca"],
    
    # same for splitting according to first / second test half
    box_first_second = box_first_second, 
    box_first_second_ci_lower = box_first_second_ci$lims["0.025","bca"],
    box_first_second_ci_upper = box_first_second_ci$lims["0.975","bca"],
  )
```

```{r save_splithalfr}
save_splithalf

write.csv(save_splithalf, "gafo-splithalf.csv", quote = F, row.names = F)
saveRDS(save_splithalf, file = "gafo-splithalf.rds")
```

