---
title: "supplements_webcamcoding"
author: "Julia Prein"
date: '2022-04-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(brms)
library(ggridges)
library(ggpubr)
library(tidybayes)

options(scipen = 999)
theme_set(theme_classic())
```

```{r load_data}
webcam_data <- readRDS(file = "../data/tango-testtrials.rds") %>% 
  filter(studytype == "vali" & datacollection == "remote - unsupervised" & studyversion == "box" & webcam == TRUE & ageInYears == 3) %>% 
  group_by(subjID) %>% 
  # determine order of factors
  mutate(
    # for models, summarize targetPositions in a way that it's symmetrical for left/ right side
    # the smaller the value, the more central the position
    symmetricPosition = case_when(
                                  targetPosition == "box3" ~ 0, 
                                  targetPosition == "box2" | targetPosition == "box4" ~ 1,
                                  targetPosition == "box1" | targetPosition == "box5" ~ 2),
    targetPosition = factor(targetPosition, levels = c("box1", "box2", "box3", "box4", "box5")), 
    proportionCorrectBox = mean(correctBox, na.rm = TRUE),
  )
```

### MODELS ON TRIAL LEVEL

```{r webcam_perTrial_datapreparation}
# prepare data
mData <- webcam_data %>% 
  ungroup() %>% 
  mutate(
    correct = as.numeric(correctBox), 
    
    # scaled (centered around mean, SD = 1, i.e., z-transformed)
    age = scale(ageInMonths, scale = TRUE, center = TRUE), 
    trial = scale(trialNr, center = TRUE, scale = TRUE), 
    repeatedTestquestion = scale(nrRepeatedTestquestion, center = TRUE, scale = TRUE),
    verificationChoice = scale(nrVerificationChoice, center = TRUE, scale = TRUE),
    hintsEyes = scale(nrHintsEyes, center = TRUE, scale = TRUE),
    nrParentSpeech = replace_na(nrParentSpeech, 0), 
    parentSpeech = scale(nrParentSpeech, center = TRUE, scale = TRUE),
    parentalInterference = -(repeatedTestquestion) + -(verificationChoice) + hintsEyes, 
    pi = scale(parentalInterference, scale = TRUE, center = TRUE), 
  ) %>% 
  select(trial, subjID, correct, symmetricPosition, targetPosition, age, parentalInterference, pi, repeatedTestquestion, verificationChoice, hintsEyes, parentSpeech)
```

```{r webcam_perTrial_models}
# originally: 
# brm(correct ~ age + datacollection + symmetricPosition + trialNr + (1 + symmetricPosition + trialNr | subjID)
# simplified the model, since not a lot of data / info to estimate all the parameters. 

mPerTrialNull <- brm(correct ~ age + symmetricPosition + (1 + symmetricPosition | subjID), 
                              data   = mData, 
                              family = bernoulli(link = "logit"), 
                              warmup = 1000, 
                              iter   = 3000, 
                              chains = 4, 
                              inits  = "random",
                              cores  = 4) %>%
  add_criterion(c("loo","waic"))

# we decided to build an index since we're rather interested in the additive effect of the parameters; general parental inference
# we don't want to know what happens if we e.g. set repeatedQuestion & verfication to zero how does hintsEyes influence correct

# index: repeated testquestion & verification choice tend to lean into negative effect, 
# hints eyes rather positive. therefore -, - + for summing up
mPerTrialPI <- update(mPerTrialNull,
                      newdata = mData,
                      formula = correct ~ pi + age + symmetricPosition + (1 + symmetricPosition | subjID),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerTrialRepeatedTestquestion <- update(mPerTrialNull,
                      newdata = mData,
                      formula = correct ~ repeatedTestquestion + age + symmetricPosition + (1 + symmetricPosition | subjID),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerTrialVerificationChoice <- update(mPerTrialNull,
                      newdata = mData,
                      formula = correct ~ verificationChoice + age + symmetricPosition + (1 + symmetricPosition | subjID),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerTrialHintsEyes <- update(mPerTrialNull,
                      newdata = mData,
                      formula = correct ~ hintsEyes + age + symmetricPosition + (1 + symmetricPosition | subjID),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))


mPerTrialParentSpeech <- update(mPerTrialNull,
                      newdata = mData,
                      formula = correct ~ parentSpeech + age + symmetricPosition + (1 + symmetricPosition | subjID),
                      family = bernoulli(link = "logit"),
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))
```

```{r webcam_perTrial_comparisons}
mPerTrialComparison <- loo_compare(mPerTrialNull, mPerTrialPI, mPerTrialRepeatedTestquestion, mPerTrialVerificationChoice, mPerTrialHintsEyes, mPerTrialParentSpeech, criterion = "waic") %>% as_tibble(rownames = "model") %>%
  left_join(as_tibble(model_weights(mPerTrialNull, mPerTrialPI, mPerTrialRepeatedTestquestion, mPerTrialVerificationChoice, mPerTrialHintsEyes, mPerTrialParentSpeech, weights = "waic"), rownames = "model")) %>% 
  rename(modelweight = value)

mPerTrialComparison
```

```{r webcam_perTrial_posteriordraws}
perTrial_draws <- bind_rows(
  mPerTrialPI %>% gather_draws(b_pi),
  mPerTrialRepeatedTestquestion %>% gather_draws(b_repeatedTestquestion), 
  mPerTrialVerificationChoice %>% gather_draws(b_verificationChoice), 
  mPerTrialHintsEyes %>% gather_draws(b_hintsEyes), 
  mPerTrialParentSpeech %>% gather_draws(b_parentSpeech), 
  ) %>% 
  mutate(
    predictor = factor(.variable, 
                       levels = c("b_verificationChoice", 
                                  "b_pi", 
                                  "b_repeatedTestquestion", 
                                  "b_parentSpeech", 
                                  "b_hintsEyes"
                       ), 
                       labels = c("# Verification choice", 
                                  "Parental interference index",
                                  "# Repeated testquestion", 
                                  "# Words uttered by caregiver", 
                                  "# Hints towards eyes"
                       )
                )  
  ) %>% 
  rename(estimate = .value)

write.csv(perTrial_draws, "../saves/supplements-webcamcoding-perTrialdraws.csv", quote = F, row.names = F)
saveRDS(perTrial_draws, "../saves/supplements-webcamcoding-perTrialdraws.rds")
```

```{r webcam_perTrial_plot}
perTrial_plot <- perTrial_draws %>% 
  ggplot(., aes(x = estimate, y = predictor)) +
  tidybayes::stat_halfeye(.width = c(.95, .8), scale = 1, slab_color = "#006c66", slab_fill = "#EBECEC", slab_alpha = 0.9) +
  labs(x = "Posterior estimate", y = "") +
  guides(fill = "none") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  coord_cartesian(expand = TRUE, ylim = c(1.5, 5.5)) +
  theme_classic()

perTrial_plot

saveRDS(perTrial_plot, file = "../saves/tango_supplements_webcamcoding_perTrial_plot.rds")
# ggsave("../figures/tango_supplements_webcamcoding_perTrial.png", width = 10, height = 6, scale = 0.7, bg = "white")
```

### MODELS ON SUBJECT LEVEL

```{r webcam_perSubject_datapreparation}
mDataSubj <- webcam_data %>% 
  group_by(subjID) %>% 
  mutate(
    trials = n(),
    correctTrials = sum(correctBox), 
    repeatedTestquestion = sum(nrRepeatedTestquestion), 
    verificationChoice = sum(nrVerificationChoice), 
    hintsEyes = sum(nrHintsEyes), 
    parentalInterference = -(repeatedTestquestion) + verificationChoice + -(hintsEyes),
    nrParentSpeech = replace_na(nrParentSpeech, 0), 
    parentSpeech = sum(nrParentSpeech), 
  ) %>% 
  slice(1) %>% 
  # for scaling we need ungrouped data!
  ungroup() %>% 
  mutate(
    age = ageInMonths - mean(ageInMonths), 
    pi = scale(parentalInterference, scale = TRUE, center = TRUE), 
  ) %>% 
  select(subjID, correctTrials, trials, age, repeatedTestquestion, verificationChoice, hintsEyes, parentSpeech, pi)
```

```{r webcam_perSubject_models}
mPerSubjectNull <- brm(correctTrials |  trials(trials) ~ age, 
                              data   = mDataSubj, 
                              family = binomial(link = "logit"), 
                              warmup = 1000, 
                              iter   = 3000, 
                              chains = 4, 
                              inits  = "random",
                              cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerSubjectPI <- update(mPerSubjectNull,
                      newdata = mDataSubj,
                      formula = correctTrials |  trials(trials) ~ age + pi, 
                      family = binomial(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerSubjectRepeatedTestquestion <- update(mPerSubjectNull,
                      newdata = mDataSubj,
                      formula = correctTrials |  trials(trials) ~ age + repeatedTestquestion, 
                      family = binomial(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerSubjectVerificationChoice <- update(mPerSubjectNull,
                      newdata = mDataSubj,
                      formula = correctTrials |  trials(trials) ~ age + verificationChoice, 
                      family = binomial(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerSubjectHintsEyes <- update(mPerSubjectNull,
                      newdata = mDataSubj,
                      formula = correctTrials |  trials(trials) ~ age + hintsEyes, 
                      family = binomial(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))

mPerSubjectParentSpeech <- update(mPerSubjectNull,
                      newdata = mDataSubj,
                      formula = correctTrials |  trials(trials) ~ age + parentSpeech, 
                      family = binomial(link = "logit"), 
                      warmup = 1000, 
                      iter   = 3000, 
                      chains = 4, 
                      inits  = "random",
                      cores  = 4) %>%
  add_criterion(c("loo","waic"))
```

```{r webcam_perSubject_comparisons}
mPerSubjectComparison <- loo_compare(mPerSubjectNull, mPerSubjectPI, mPerSubjectRepeatedTestquestion, mPerSubjectVerificationChoice, mPerSubjectHintsEyes, mPerSubjectParentSpeech, criterion = "waic") %>% as_tibble(rownames = "model") %>%
  left_join(as_tibble(model_weights(mPerSubjectNull, mPerSubjectPI, mPerSubjectRepeatedTestquestion, mPerSubjectVerificationChoice, mPerSubjectHintsEyes, mPerSubjectParentSpeech, weights = "waic"), rownames = "model")) %>% 
  rename(modelweight = value)

mPerSubjectComparison
```

```{r webcam_perSubject_posteriordraws}
perSubject_draws <- bind_rows(
  mPerSubjectPI %>% gather_draws(b_pi),
  mPerSubjectRepeatedTestquestion %>% gather_draws(b_repeatedTestquestion), 
  mPerSubjectVerificationChoice %>% gather_draws(b_verificationChoice), 
  mPerSubjectHintsEyes %>% gather_draws(b_hintsEyes), 
  mPerSubjectParentSpeech %>% gather_draws(b_parentSpeech), 
  ) %>% 
  mutate(
    predictor = factor(.variable, 
                       levels = c("b_verificationChoice", 
                                  "b_pi", 
                                  "b_repeatedTestquestion", 
                                  "b_parentSpeech", 
                                  "b_hintsEyes"
                       ), 
                       labels = c("# Verification choice", 
                                  "Parental interference index",
                                  "# Repeated testquestion", 
                                  "# Words uttered by caregiver", 
                                  "# Hints towards eyes"
                       )
                )
  ) %>% 
  rename(estimate = .value)

write.csv(perSubject_draws, "../saves/supplements-webcamcoding-perSubjectdraws.csv", quote = F, row.names = F)
saveRDS(perSubject_draws, "../saves/supplements-webcamcoding-perSubjectdraws.rds")
```

```{r webcam_perSubject_plot}
perSubject_plot <- perSubject_draws %>% 
  ggplot(., aes(x = estimate, y = predictor)) +
  tidybayes::stat_halfeye(.width = c(.95, .8), scale = 1, slab_color = "#006c66", slab_fill = "#EBECEC", slab_alpha = 0.9) +
  labs(x = "Posterior estimate", y = "") +
  guides(fill = "none") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  coord_cartesian(expand = TRUE, ylim = c(1.5, 5.5)) +
  theme_classic()

perSubject_plot

saveRDS(perSubject_plot, file = "../saves/tango_supplements_webcamcoding_perSubject_plot.rds")
# ggsave("../figures/tango_supplements_webcamcoding_perSubject.png", width = 10, height = 6, scale = 0.7, bg = "white")
```

```{r combined_plot}
ggarrange(perTrial_plot,
          perSubject_plot,
          nrow = 1,
          labels = c("A", "B")
          )

ggsave("../figures/tango_supplements_webcamcoding.png", width = 10, height = 5, scale = 1, bg = "white")
```

```{r overall_save}
overall_results <- bind_rows(mPerTrialComparison, mPerSubjectComparison) %>% 
  select(model, waic, se_waic, modelweight, elpd_diff, se_diff) %>% 
  rename(
    Predictor = model, 
    WAIC = waic, 
    SE_WAIC = se_waic,
    Weight = modelweight, 
    ELPD_DIFF = elpd_diff, 
    SE_ELPD_DIFF = se_diff,
  ) %>% 
  mutate(
    Predictor = recode(Predictor, 
                   "mPerTrialVerificationChoice" = "By trial - # Verification choice", 
                   "mPerTrialNull" = "By trial - Null model", 
                   "mPerTrialPI" = "By trial - Parental interference index", 
                   "mPerTrialRepeatedTestquestion" = "By trial - # Repeated testquestion", 
                   "mPerTrialParentSpeech" = "By trial - # Words uttered by caregiver", 
                   "mPerTrialHintsEyes" = "By trial - # Hints eyes", 
                   "mPerSubjectRepeatedTestquestion" = "By subject - # Repeated testquestion", 
                   "mPerSubjectPI" = "By subject - Parental interference index", 
                   "mPerSubjectNull" = "By subject - Null model", 
                   "mPerSubjectVerificationChoice" = "By subject - # Verification choice", 
                   "mPerSubjectParentSpeech" = "By subject - # Words uttered by caregiver", 
                   "mPerSubjectHintsEyes" = "By subject - # Hints eyes"
                   )
  )

overall_results

write.csv(overall_results, "../saves/supplements-webcamcoding-results.csv", quote = F, row.names = F)
saveRDS(overall_results, "../saves/supplements-webcamcoding-results.rds")
```

